# 프로젝트 아키텍처: RAG 기반 지리과 서답형 자동 채점 플랫폼

## 1. 전체 시스템 개요
이 플랫폼은 RAG(검색 증강 생성) 및 LLM(대규모 언어 모델)을 활용하여 지리 서답형 문항을 자동 채점하고 상세한 피드백을 제공합니다. 사용자는 원본 학습 자료, 채점 기준(루브릭), 그리고 학생들의 답안(텍스트 또는 백지도 이미지)을 시스템에 입력하여 채점 결과를 확인할 수 있습니다.

## 2. 핵심 구성 요소 및 역할

*   **`main.py`**: Streamlit 기반의 사용자 인터페이스(UI)를 구성하고 전체 시스템의 워크플로우를 관리하는 핵심 실행 파일입니다. 사용자 입력 처리, 데이터 흐름 제어, 그리고 각 모듈의 실행을 총괄합니다.

*   **`models/llm_manager.py`**: 다양한 LLM(GROQ, OpenAI, Google Gemini 등)과의 상호작용을 추상화하여 일관된 인터페이스를 제공합니다. 모델 선택 및 API 호출을 관리합니다.

*   **`prompts/prompt_templates.py`**: LLM에 전달할 프롬프트 템플릿을 정의합니다. 문항 유형(단답형, 제한형, 확장형, 백지도)에 따라 최적화된 지시문을 생성하여 일관되고 정확한 채점 결과를 유도합니다.

*   **`utils/` 디렉토리**: 다양한 보조 기능을 수행하는 모듈들을 포함합니다.
    *   **`data_loader.py`**: PDF, DOCX, TXT 등 다양한 형식의 원본 학습 자료를 로드하고 기본적인 전처리를 수행합니다.
    *   **`text_splitter.py`**: 로드된 문서를 의미 있는 단위의 청크(Chunk)로 분할합니다.
    *   **`embedding.py`**: 텍스트 청크를 벡터로 변환하는 임베딩 모델을 관리합니다.
    *   **`vector_db.py`**: FAISS를 사용하여 벡터 데이터베이스를 생성하고 관리하며, 이를 통해 빠른 유사도 검색을 지원합니다.
    *   **`rubric_manager.py`**: 사용자가 GUI를 통해 채점 기준(루브릭)을 동적으로 생성하고 수정할 수 있는 기능을 제공합니다.
    *   **`student_answer_loader.py`**: Excel 파일 형식의 학생 답안 목록을 불러옵니다.
    *   **`retrieval.py`**: 벡터 DB에서 학생 답안과 관련된 문서를 검색하고, 검색된 문서를 재순위화(Re-ranking)하여 LLM에 가장 정확한 컨텍스트를 제공합니다.
    *   **`dashboard.py`**: 채점 결과를 바탕으로 다양한 차트와 통계를 시각화하여 보여줍니다.
    *   **`map_item.py`**: 백지도 이미지 채점을 위한 특수 모듈입니다. LLaVA 모델을 사용하여 이미지 내의 텍스트를 인식하고, 이를 바탕으로 채점 프롬프트를 생성합니다.

*   **`vector_db/` 디렉토리**: 생성된 FAISS 인덱스 파일(`index.faiss`, `index.pkl`)을 저장하여, 재실행 시 벡터 DB를 다시 구축할 필요 없이 빠르게 로드할 수 있도록 합니다.

## 3. `main.py`를 통한 단계별 워크플로우

`main.py`는 Streamlit UI를 통해 아래의 단계별 워크플로우를 진행합니다.

1.  **데이터 준비**: 사용자가 원본 학습 자료(PDF, DOCX 등)를 업로드하면, `data_loader.py`가 문서를 로드하고 `text_splitter.py`가 이를 청크로 분할합니다. 이후 `embedding.py`과 `vector_db.py`를 통해 벡터 데이터베이스가 구축됩니다.

2.  **채점 설정**: 사용자는 UI를 통해 사용할 LLM 모델(`llm_manager.py`)을 선택하고, `rubric_manager.py`를 이용해 채점 기준(루브릭)을 설정합니다.

3.  **학생 답안 처리**:
    *   **텍스트 기반 문항**: `student_answer_loader.py`를 통해 Excel 파일에서 학생들의 답안을 불러옵니다.
    *   **백지도 문항**: 사용자가 직접 학생들의 백지도 이미지 파일을 업로드합니다.

4.  **자동 채점 실행**: "채점 시작" 버튼을 클릭하면, `main.py`는 선택된 문항 유형에 따라 채점 로직을 수행합니다.
    *   **텍스트 기반 문항**: `process_student_answer` 함수가 각 학생 답안에 대해 `retrieval.py`로 관련 문서를 검색하고, `prompts/prompt_templates.py`로 프롬프트를 생성한 후, `llm_manager.py`를 통해 LLM을 호출하여 채점 결과를 JSON 형식으로 받습니다.
    *   **백지도 문항**: `grade_map_question` 함수가 `map_item.py`의 LLaVA 모델을 사용하여 이미지에서 텍스트를 추출하고, 이 텍스트를 기반으로 `retrieval.py`를 통해 관련 문서를 검색합니다. 이후 `map_item.py`에서 백지도 채점 전용 프롬프트를 생성하고 `llm_manager.py`를 통해 LLM을 호출하여 채점 결과를 받습니다.

5.  **결과 확인 및 분석**:
    *   채점이 완료된 결과는 `main.py`의 결과 테이블에 표시됩니다. 이 테이블에는 학생 이름, 답안, 채점 결과, 피드백, 참고 문서, 채점 소요 시간 등의 정보가 포함됩니다.
    *   사용자는 개별 학생의 상세 결과보기를 통해 각 채점 항목별 점수, 점수 부여 근거, 그리고 LLM이 생성한 상세 피드백을 확인할 수 있습니다.
    *   `dashboard.py`를 통해 전체 학생들의 점수 분포, 평균 점수 등 다양한 통계 정보를 시각화된 차트로 확인할 수 있습니다.
    *   모든 채점 결과는 Excel 파일로 다운로드하여 추가적인 분석이나 보관이 가능합니다.

이러한 아키텍처를 통해 `main.py`는 각 전문 모듈들을 유기적으로 연결하여, 복잡한 RAG 기반의 자동 채점 프로세스를 사용자 친화적인 웹 인터페이스에서 효율적으로 실행할 수 있도록 지원합니다.